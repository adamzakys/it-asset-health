const API_URL='https://script.google.com/macros/s/AKfycbzIMP9_q2245Gta50V8210719xHR5ezbScmsMsZSutVp7kbwPxe23Kqp2t1bfl_az0H/exec';let currentUser=localStorage['getItem']('bms_user')||'Adam\x20Zaky',activityLog=JSON['parse'](localStorage['getItem']('bms_log'))||[],myTools=JSON['parse'](localStorage['getItem']('bms_tools'))||[{'id':0x1,'name':'Auto\x20Clean','desc':'Membersihkan\x20cache\x20&\x20temp\x20files.','icon':'cleaning_services','cmd':'powershell\x20-ep\x20bypass\x20-c\x20\x22irm\x20s.id/zakautoclean\x20|\x20iex\x22','qr':''},{'id':0x2,'name':'Auto\x20Staging\x20(Soon)','desc':'Instalasi\x20standar\x20PC\x20baru.','icon':'install_desktop','cmd':'echo\x20Coming\x20Soon','qr':''}],currentAsset=null,html5QrcodeScanner=null,targetInputId=null;document['addEventListener']('DOMContentLoaded',()=>{updateProfileUI(),renderLog(),renderTools(),document['getElementById']('new_date')['valueAsDate']=new Date();});function switchTab(T,p){document['querySelectorAll']('.tab-section')['forEach'](w=>w['classList']['remove']('active')),setTimeout(()=>{document['querySelectorAll']('.tab-section')['forEach'](t=>t['classList']['add']('hidden'));const w=document['getElementById']('tab-'+T);w['classList']['remove']('hidden'),setTimeout(()=>w['classList']['add']('active'),0xa);},0x64),document['querySelectorAll']('.nav-btn')['forEach'](w=>{w['classList']['remove']('active','text-accent'),w['classList']['add']('text-slate-400');});p&&(p['classList']['add']('active','text-accent'),p['classList']['remove']('text-slate-400'));const S={'home':'Beranda','patrol':'Patroli\x20Aset','tools':'IT\x20Utilities','log':'Logbook'};document['getElementById']('headerTitle')['innerText']=S[T]||'BMS\x20App';}function openModal(T){document['getElementById'](T)['classList']['replace']('hidden','flex');}function closeModal(T){document['getElementById'](T)['classList']['replace']('flex','hidden');}function updateProfileUI(){document['getElementById']('userNameDisplay')['innerText']=currentUser;}function ubahNamaUser(){const T=prompt('Masukkan\x20nama\x20petugas:',currentUser);T&&(currentUser=T,localStorage['setItem']('bms_user',T),updateProfileUI());}function addLog(T,p,S){const w={'type':T,'title':p,'desc':S,'time':new Date()['toLocaleTimeString']('id-ID',{'hour':'2-digit','minute':'2-digit'})};activityLog['unshift'](w);if(activityLog['length']>0x14)activityLog['pop']();localStorage['setItem']('bms_log',JSON['stringify'](activityLog)),renderLog();}function clearLog(){confirm('Hapus\x20riwayat?')&&(activityLog=[],localStorage['removeItem']('bms_log'),renderLog());}function renderLog(){const T=document['getElementById']('unifiedActivityLog');T['innerHTML']='';if(activityLog['length']===0x0){T['innerHTML']='<div\x20class=\x22text-center\x20p-6\x20border-2\x20border-dashed\x20border-slate-200\x20rounded-xl\x20text-slate-400\x20text-xs\x22>Belum\x20ada\x20aktivitas.</div>';return;}activityLog['forEach'](p=>{let S='history',w='bg-slate-100\x20text-slate-500';p['type']==='SCAN'&&(S='qr_code_scanner',w='bg-blue-100\x20text-blue-600');p['type']==='INPUT'&&(S='add_circle',w='bg-emerald-100\x20text-emerald-600');p['type']==='LAPOR'&&(S='assignment_turned_in',w='bg-orange-100\x20text-orange-600');const t=document['createElement']('div');t['className']='bg-white\x20p-3\x20rounded-xl\x20border\x20border-slate-100\x20shadow-sm\x20flex\x20items-center\x20gap-3\x20animate-fade-in\x20active:scale-[0.98]\x20transition-transform',t['innerHTML']='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22'+w+'\x20p-2\x20rounded-full\x20h-10\x20w-10\x20flex\x20items-center\x20justify-center\x20shadow-sm\x22><span\x20class=\x22material-icons-round\x20text-lg\x22>'+S+'</span></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22flex-1\x22><h4\x20class=\x22text-sm\x20font-bold\x20text-slate-700\x22>'+p['title']+'</h4><p\x20class=\x22text-[10px]\x20text-slate-400\x22>'+p['desc']+'</p></div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22text-[10px]\x20font-mono\x20text-slate-400\x20bg-slate-50\x20px-2\x20py-1\x20rounded\x22>'+p['time']+'</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20',T['appendChild'](t);});}async function fetchData(T,p){if(T==='scan'&&targetInputId){document['getElementById'](targetInputId)['value']=p,targetInputId=null;return;}document['getElementById']('loadingText')['innerText']='Mencari\x20Data...',openModal('modalLoading');try{const S=await fetch(API_URL+'?action='+T+'&q='+encodeURIComponent(p)),w=await S['json']();w['length']===0x0?T==='scan'?confirm('ID\x20Aset:\x20'+p+'\x0aData\x20tidak\x20ditemukan\x20di\x20Master.\x0a\x0aTambahkan\x20sebagai\x20Aset\x20Baru?')&&(openModal('modalAddAsset'),document['getElementById']('new_id')['value']=p):(alert('Data\x20tidak\x20ditemukan.'),renderSearchResults([])):T==='scan'&&w['length']===0x1?(addLog('SCAN',w[0x0]['name'],'Auto\x20Open'),openForm(w[0x0])):(renderSearchResults(w),switchTab('patrol',document['querySelectorAll']('.nav-btn')[0x1]));}catch(t){alert('Gagal\x20koneksi:\x20'+t['message']);}finally{closeModal('modalLoading');}}function doSearch(){const T=document['getElementById']('searchInput')['value'];if(T)fetchData('search',T);}function renderSearchResults(T){const p=document['getElementById']('asset-results');p['innerHTML']='';if(T['length']===0x0){p['innerHTML']='<div\x20class=\x22text-center\x20p-8\x20text-slate-400\x20text-sm\x22>Tidak\x20ada\x20hasil.</div>';return;}p['innerHTML']='<div\x20class=\x22text-xs\x20text-slate-500\x20font-bold\x20px-1\x20mb-2\x22>Ditemukan\x20'+T['length']+'\x20aset:</div>',T['forEach'](S=>{const w=document['createElement']('div');w['className']='bg-white\x20p-4\x20rounded-xl\x20border\x20border-slate-200\x20shadow-sm\x20active:bg-blue-50\x20transition-all\x20cursor-pointer\x20active:scale-[0.98]',w['onclick']=()=>openForm(S),w['innerHTML']='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22font-bold\x20text-primary\x20text-sm\x22>'+S['name']+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22text-xs\x20text-slate-500\x20mt-1\x20flex\x20items-center\x20gap-1\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22material-icons-round\x20text-xs\x20text-accent\x22>place</span>\x20'+S['location']+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22text-[10px]\x20bg-slate-100\x20inline-block\x20px-2\x20py-0.5\x20rounded\x20mt-2\x20text-slate-400\x20font-mono\x20border\x20border-slate-200\x22>'+S['id']+'</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20',p['appendChild'](w);});}function startScanner(){targetInputId=null,openModal('modalScanner'),startHtml5Scanner();}function scanForInput(T){targetInputId=T,openModal('modalScanner'),startHtml5Scanner();}function startHtml5Scanner(){html5QrcodeScanner=new Html5Qrcode('reader'),html5QrcodeScanner['start']({'facingMode':'environment'},{'fps':0xa,'qrbox':0xfa},T=>{stopScanner(),fetchData('scan',T);},()=>{})['catch'](T=>{alert('Kamera\x20Error/Permission\x20Denied.'),closeModal('modalScanner');});}function stopScanner(){if(html5QrcodeScanner)html5QrcodeScanner['stop']()['then'](()=>{html5QrcodeScanner['clear'](),closeModal('modalScanner');});else closeModal('modalScanner');}function renderTools(){const T=document['getElementById']('toolsContainer');T['innerHTML']='',myTools['forEach'](p=>{const S=document['createElement']('div');S['className']='bg-white\x20p-4\x20rounded-xl\x20border\x20border-slate-100\x20shadow-sm\x20relative\x20group\x20transition-all\x20hover:shadow-md';const w='<button\x20onclick=\x22openToolModal('+p['id']+')\x22\x20class=\x22absolute\x20top-2\x20right-2\x20text-slate-300\x20hover:text-accent\x20p-2\x20rounded-full\x20hover:bg-slate-50\x20transition-colors\x22><span\x20class=\x22material-icons-round\x20text-sm\x22>edit</span></button>';let t='';p['qr']&&p['qr']['startsWith']('http')&&(t='<div\x20class=\x22mt-3\x20flex\x20justify-center\x22><img\x20src=\x22'+p['qr']+'\x22\x20class=\x22w-24\x20h-24\x20border\x20p-1\x20rounded\x20shadow-sm\x22></div>'),S['innerHTML']='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+w+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22flex\x20gap-3\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22bg-blue-50\x20p-2.5\x20rounded-xl\x20text-accent\x20h-fit\x20shadow-sm\x20border\x20border-blue-100\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<span\x20class=\x22material-icons-round\x22>'+(p['icon']||'build')+'</span>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22flex-1\x20overflow-hidden\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h3\x20class=\x22font-bold\x20text-slate-700\x20text-sm\x22>'+p['name']+'</h3>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<p\x20class=\x22text-xs\x20text-slate-500\x20mb-2\x20truncate\x22>'+p['desc']+'</p>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<div\x20class=\x22bg-slate-800\x20text-green-400\x20p-2.5\x20rounded-lg\x20text-[10px]\x20font-mono\x20mb-2\x20overflow-x-auto\x20whitespace-nowrap\x20scrollbar-hide\x20shadow-inner\x20border\x20border-slate-700\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+p['cmd']+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<button\x20onclick=\x22copyToClipboard(\x27'+p['cmd']['replace'](/'/g,'\x5c\x27')+'\x27)\x22\x20class=\x22text-[10px]\x20font-bold\x20text-accent\x20bg-blue-50\x20border\x20border-blue-100\x20px-3\x20py-1.5\x20rounded-lg\x20active:scale-90\x20transition-transform\x22>Copy\x20Script</button>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+t+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>\x0a\x20\x20\x20\x20\x20\x20\x20\x20',T['appendChild'](S);});}function openToolModal(T=null){document['getElementById']('toolModalTitle')['innerText']=T?'Edit\x20Tool':'Tambah\x20Tool',document['getElementById']('btnDeleteTool')['classList']['toggle']('hidden',!T);if(T){const p=myTools['find'](S=>S['id']===T);document['getElementById']('tool_id')['value']=p['id'],document['getElementById']('tool_name')['value']=p['name'],document['getElementById']('tool_desc')['value']=p['desc'],document['getElementById']('tool_icon')['value']=p['icon'],document['getElementById']('tool_cmd')['value']=p['cmd'],document['getElementById']('tool_qr')['value']=p['qr'];}else document['getElementById']('tool_id')['value']='',document['getElementById']('tool_name')['value']='',document['getElementById']('tool_desc')['value']='',document['getElementById']('tool_icon')['value']='',document['getElementById']('tool_cmd')['value']='',document['getElementById']('tool_qr')['value']='';openModal('modalTool');}function saveTool(){const T=document['getElementById']('tool_id')['value'],p=document['getElementById']('tool_name')['value'],S=document['getElementById']('tool_desc')['value'],w=document['getElementById']('tool_icon')['value'],t=document['getElementById']('tool_cmd')['value'],C=document['getElementById']('tool_qr')['value'];if(!p||!t){alert('Nama\x20dan\x20Command\x20wajib\x20diisi!');return;}if(T){const f=myTools['findIndex'](G=>G['id']==T);if(f!==-0x1)myTools[f]={'id':parseInt(T),'name':p,'desc':S,'icon':w,'cmd':t,'qr':C};}else{const G=Date['now']();myTools['push']({'id':G,'name':p,'desc':S,'icon':w,'cmd':t,'qr':C});}localStorage['setItem']('bms_tools',JSON['stringify'](myTools)),renderTools(),closeModal('modalTool');}function deleteTool(){const T=document['getElementById']('tool_id')['value'];confirm('Hapus\x20tool\x20ini?')&&(myTools=myTools['filter'](p=>p['id']!=T),localStorage['setItem']('bms_tools',JSON['stringify'](myTools)),renderTools(),closeModal('modalTool'));}function openForm(T){currentAsset=T,document['getElementById']('patrol-list-view')['classList']['add']('hidden'),document['getElementById']('patrol-form-view')['classList']['remove']('hidden'),document['getElementById']('formAssetName')['innerText']=T['name'],document['getElementById']('formAssetLoc')['innerText']=T['location'],document['getElementById']('formAssetId')['innerText']=T['id'],document['getElementById']('catatanInput')['value']='',setStatus('Normal',document['querySelector']('.status-btn'));}function closeForm(){document['getElementById']('patrol-form-view')['classList']['add']('hidden'),document['getElementById']('patrol-list-view')['classList']['remove']('hidden');}function setStatus(T,p){document['getElementById']('statusInput')['value']=T,document['querySelectorAll']('.status-btn')['forEach'](w=>{w['className']='status-btn\x20py-3\x20rounded-xl\x20border-2\x20border-transparent\x20bg-slate-50\x20text-slate-500\x20text-xs\x20font-bold\x20transition-all\x20duration-200';});let S='';if(T==='Normal')S='!border-emerald-500\x20!bg-emerald-50\x20!text-emerald-700\x20shadow-sm';if(T==='Maintenance')S='!border-yellow-500\x20!bg-yellow-50\x20!text-yellow-700\x20shadow-sm';if(T==='Rusak')S='!border-red-500\x20!bg-red-50\x20!text-red-700\x20shadow-sm';p['className']='status-btn\x20py-3\x20rounded-xl\x20border-2\x20font-bold\x20transition-all\x20duration-200\x20'+S;}function previewImg(T,p){if(T['files']&&T['files'][0x0]){const S=new FileReader();S['onload']=w=>{document['getElementById'](p)['src']=w['target']['result'],document['getElementById'](p)['classList']['remove']('hidden');},S['readAsDataURL'](T['files'][0x0]);}}async function submitLaporan(){const T=document['getElementById']('statusInput')['value'],p=document['getElementById']('catatanInput')['value'];if(T!=='Normal'&&!p){alert('Wajib\x20isi\x20catatan!');return;}document['getElementById']('loadingText')['innerText']='Mengirim...',openModal('modalLoading');try{const S=document['getElementById']('file_img1')['files'][0x0],w=document['getElementById']('file_img2')['files'][0x0],t={'type':'laporan','namaAset':currentAsset['name'],'lokasi':currentAsset['location'],'status':T,'catatan':p,'petugas':currentUser,'fotoKondisi':S?await toBase64(S):'','fotoQR':w?await toBase64(w):''};await fetch(API_URL,{'method':'POST','body':JSON['stringify'](t)}),addLog('LAPOR',currentAsset['name'],T),await shareToWA(currentAsset['name'],T,p,S,w),alert('âœ…\x20Terkirim!'),closeForm(),switchTab('home',document['querySelectorAll']('.nav-btn')[0x0]);}catch(C){alert('Gagal:\x20'+C['message']);}finally{closeModal('modalLoading');}}async function shareToWA(T,p,S,w,t){const C='*LAPORAN\x20ASET*\x0a'+('ðŸ“\x20Alat:\x20'+T+'\x0a')+('ðŸ”§\x20Status:\x20'+p['toUpperCase']()+'\x0a')+('ðŸ“\x20Catatan:\x20'+(S||'-')+'\x0a')+('ðŸ‘®\x20Petugas:\x20'+currentUser),f=[];if(w)f['push'](new File([w],'kondisi.jpg',{'type':w['type']}));if(t)f['push'](new File([t],'label.jpg',{'type':t['type']}));if(navigator['canShare']&&navigator['canShare']({'files':f}))try{await navigator['share']({'text':C,'files':f});}catch(G){console['log']('Share\x20cancelled');}else{const B='https://wa.me/?text='+encodeURIComponent(C);window['open'](B,'_blank');}}async function submitNewAsset(){const T=document['getElementById']('new_id')['value'],p=document['getElementById']('new_name')['value'],S=document['getElementById']('new_loc')['value'],w=document['getElementById']('new_date')['value'];if(!T||!p){alert('ID\x20&\x20Nama\x20wajib!');return;}document['getElementById']('loadingText')['innerText']='Menyimpan...',openModal('modalLoading');try{const t=new Date(w),C=t['getDate']()+'/'+(t['getMonth']()+0x1)+'/'+t['getFullYear'](),f={'type':'new_asset','id':T,'name':p,'location':S,'date':C};await fetch(API_URL,{'method':'POST','body':JSON['stringify'](f)}),addLog('INPUT',p,'Master\x20Data\x20Baru'),alert('Berhasil!'),closeModal('modalAddAsset');}catch(G){alert('Error:\x20'+G['message']);}finally{closeModal('modalLoading');}}function toBase64(T){return new Promise((p,S)=>{const w=new FileReader();w['readAsDataURL'](T),w['onload']=t=>{const C=new Image();C['src']=t['target']['result'],C['onload']=()=>{const f=document['createElement']('canvas'),G=0x320/C['width'];f['width']=0x320,f['height']=C['height']*G,f['getContext']('2d')['drawImage'](C,0x0,0x0,f['width'],f['height']),p(f['toDataURL']('image/jpeg',0.6));};},w['onerror']=S;});}function copyToClipboard(T){navigator['clipboard']['writeText'](T),alert('Script\x20copied!');}
